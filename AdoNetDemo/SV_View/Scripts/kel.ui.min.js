angular.module("kel.ui",[]).directive("kelAjaxCombobox",["$document","$timeout","$q",function(m,n,p){return{restrict:"E",templateUrl:"Content/kel-ajax-combobox.html",scope:{ngModel:"=",userInput:"=",resultGetter:"=",resultList:"=",resultTotalRows:"=",selectedText:"=",selectedValue:"=",width:"=",pageSize:"=",ngChange:"&"},link:function(h,q,p){function f(){1<a.pageNumber?(--a.pageNumber,d()):0<a.highlightedRow&&(a.highlightedRow=0)}function g(){a.pageNumber<a.totalPage?(++a.pageNumber,d()):a.highlightedRow<
a.resultList.length-1&&(a.highlightedRow=a.resultList.length-1)}function d(){a.fetchDone=!1;var b=null,b=a.isFromDropdown?null:a.userInput,b=a.resultGetter({userInput:b,pageNumber:a.pageNumber,pageSize:e});void 0!=b.$promise&&(b=b.$promise);b.then(function(b){a.$applyAsync(function(){a.fetchDone=!0;a.totalPage=Math.ceil(a.resultTotalRows/e);a.highlightedRow>a.resultList.length-1&&(a.highlightedRow=a.resultList.length-1)})})}function k(){null==a.highlightedRow?a.userInput=a.oldUserInput:0<=a.highlightedRow&&
a.highlightedRow<=a.resultList.length-1?a.selectRow(a.resultList[a.highlightedRow]):a.userInput=a.oldUserInput}function r(){n(function(){l.find("input")[0].focus()},0)}var a=h;h=(new Date).getTime();a.uxUnique="um"+h;0<a.pageSize||(a.pageSize=10);var e=a.pageSize;a.pageNumber=1;a.fetchDone=!1;a.isFromDropdown=null;a.highlightedRow=null;a.oldUserInput=a.userInput;a.totalPage=0;a.cbStyle={height:20*e+36+"px"};a.cbNavStyle={top:20*e+1+"px"};var l=angular.element(q).find("div");angular.element(l[3]).bind("mousewheel DOMMouseScroll",
    function(b){var c=null;"mousewheel"==b.type?c=-1*b.wheelDelta:"DOMMouseScroll"==b.type&&(c=40*b.detail);c&&(b.preventDefault(),0>c&&1<a.pageNumber?--a.pageNumber:0<c&&++a.pageNumber,a.fetchDone&&d())});a.goToPreviousPage=f;a.goToNextPage=g;a.goToNextSegment=function(){var b=Math.ceil(a.resultTotalRows/100);a.pageNumber+b<a.totalPage?(a.pageNumber+=b,d()):g()};a.goToPreviousSegment=function(){var b=Math.ceil(a.resultTotalRows/100);0<a.pageNumber-b?(a.pageNumber-=b,d()):f()};a.setHighlightedRow=function(b){a.highlightedRow=
    b};a.navigateByKey=function(b){(115==b.which||b.altKey&&40==b.which)&&a.dropdown();40==b.which?null==a.highlightedRow?a.highlightedRow=0:(a.highlightedRow+1==a.resultList.length?a.pageNumber<a.totalPage&&(a.highlightedRow=0,g()):++a.highlightedRow,b.preventDefault()):38==b.which?null==a.highlightedRow?a.highlightedRow=e-1:(-1==a.highlightedRow-1?1<a.pageNumber&&f():--a.highlightedRow,b.preventDefault()):33==b.which?(a.isShowList&&b.preventDefault(),a.fetchDone&&f()):34==b.which&&a.fetchDone?(a.isShowList&&
b.preventDefault(),a.fetchDone&&g()):13==b.which&&a.isShowList?(k(),b.preventDefault()):27==b.which?(b.preventDefault(),a.userInput=a.oldUserInput,a.isShowList=!1):9==b.which&&(""==a.userInput?(a.ngModel=null,a.userInput="",a.oldUserInput=""):a.isShowList&&k(),a.isShowList=!1)};a.closePopup=function(){a.isShowList=!1};a.search=function(){a.isShowList=!0;a.pageNumber=1;a.isFromDropdown=!1;d()};a.selectRow=function(b){a.ngModel=b[a.selectedValue];a.userInput=b[a.selectedText];a.oldUserInput=a.userInput;
    a.isShowList=!1;a.highlightedRow=0;a.ngChange()};a.dropdown=function(){a.isShowList=!a.isShowList;a.isShowList&&(a.pageNumber=1,a.isFromDropdown=!0,d())};m.bind("click",function(b){isChildOfComboBox=!1;var c;b||(b=window.event);b.target?c=b.target:b.srcElement&&(c=b.srcElement);3==c.nodeType&&(c=c.parentNode);c=angular.element(c);for(b=0;20>b;++b){if(c.hasClass(a.uxUnique)){isChildOfComboBox=!0;break}c=c.parent()}isChildOfComboBox?r():(a.closePopup(),a.$apply())})}}}]);